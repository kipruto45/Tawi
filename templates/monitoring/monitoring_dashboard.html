<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoring Management | Tawi Tree Planting Project</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body {
      background-image: url('{% static "img/tawi_forest_bg.jpg" %}');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .glass {
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(34,197,94,0.2);
      border-radius: 18px;
      box-shadow: 0 6px 20px rgba(34,197,94,0.12);
    }
    .btn-green {
      background-color: #22c55e;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .btn-green:hover { background-color: #16a34a; }
    #map {
      height: 400px;
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(34,197,94,0.15);
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center bg-green-50/70">

  <!-- Header -->
  <header class="w-full bg-white/90 backdrop-blur-md border-b border-green-200 shadow-sm p-4 text-center">
    <h1 class="text-2xl font-bold text-green-700 tracking-wide">Monitoring Management</h1>
  </header>

  <!-- Main Content -->
  <main class="w-full max-w-6xl px-6 py-10 space-y-10">

    <!-- Action Buttons -->
    <div class="flex flex-wrap justify-center gap-4">
      <a href="{% url 'monitoring:add_monitoring' %}" class="btn-green flex items-center gap-2">
        <i data-feather="plus"></i> Add Monitoring
      </a>
      <a href="{% url 'monitoring:add_followup' %}" class="btn-green flex items-center gap-2">
        <i data-feather="clipboard-plus"></i> Add Follow-Up
      </a>
      <a href="{% url 'monitoring:monitoring_list' %}" class="btn-green flex items-center gap-2">
        <i data-feather="list"></i> View Monitoring List
      </a>
    </div>

    <!-- Monitoring Map -->
    <section class="glass p-6">
      <h2 class="text-lg font-semibold text-green-700 mb-4 flex items-center gap-2">
        <i data-feather="map-pin" class="w-5 h-5"></i> Monitoring Map
      </h2>
      <div id="map"></div>
    </section>

    <!-- Monitoring List -->
    <section class="glass p-6">
      <h2 class="text-lg font-semibold text-green-700 mb-4 flex items-center gap-2">
        <i data-feather="activity" class="w-5 h-5"></i> Recent Monitoring Activities
      </h2>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left">
          <thead class="bg-green-100 text-green-700 uppercase text-xs">
            <tr>
              <th class="px-4 py-2">#</th>
              <th class="px-4 py-2">Location</th>
              <th class="px-4 py-2">Monitored By</th>
              <th class="px-4 py-2">Health Status</th>
              <th class="px-4 py-2">Follow-Ups</th>
              <th class="px-4 py-2">Date</th>
              <th class="px-4 py-2 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for monitoring in monitoring_list %}
            <tr class="border-t border-green-100 hover:bg-green-50 transition">
              <td class="px-4 py-2">{{ forloop.counter }}</td>
              <td class="px-4 py-2 font-medium text-green-700">{{ monitoring.location }}</td>
              <td class="px-4 py-2">{{ monitoring.officer.username }}</td>
              <td class="px-4 py-2">{{ monitoring.health_status }}</td>
              <td class="px-4 py-2 text-green-600">{{ monitoring.followups.count }}</td>
              <td class="px-4 py-2 text-green-500 text-xs">{{ monitoring.date|date:"M d, Y" }}</td>
              <td class="px-4 py-2 text-center flex justify-center gap-2">
                <a href="{% url 'monitoring:monitoring_detail' monitoring.id %}" class="text-green-600 hover:text-green-800">
                  <i data-feather="eye"></i>
                </a>
                <a href="{% url 'monitoring:monitoring_edit' monitoring.id %}" class="text-green-600 hover:text-green-800">
                  <i data-feather="edit"></i>
                </a>
                <a href="{% url 'monitoring:monitoring_delete' monitoring.id %}" class="text-red-500 hover:text-red-700">
                  <i data-feather="trash-2"></i>
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center py-4 text-green-600">No monitoring records found ðŸŒ±</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer class="w-full text-center text-green-500 text-sm py-4 bg-white/70 backdrop-blur-md border-t border-green-100">
    Â© 2025 Tawi Tree Planting Project | Monitoring Portal ðŸŒ³
  </footer>

  <script>
    feather.replace();

    // Initialize Map
    const map = L.map('map').setView([0.0236, 37.9062], 6); // Default center: Kenya

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; <a href="https://www.openstreetmap.org">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Add monitoring markers (Django context data)
    const monitoringData = [
      {% for m in monitoring_list %}
      {
        lat: {{ m.latitude|default:0 }},
        lng: {{ m.longitude|default:0 }},
        location: "{{ m.location|escapejs }}",
        status: "{{ m.health_status|escapejs }}",
        date: "{{ m.date|date:'M d, Y' }}",
        officer: "{{ m.officer.username|escapejs }}"
      },
      {% endfor %}
    ];

    // Add markers for each record
    monitoringData.forEach(item => {
      if (item.lat && item.lng) {
        const color = item.status.toLowerCase().includes('healthy') ? 'green' : 'orange';
        const marker = L.circleMarker([item.lat, item.lng], {
          color,
          radius: 8,
          fillOpacity: 0.8
        }).addTo(map);

        marker.bindPopup(`
          <b>${item.location}</b><br>
          Status: ${item.status}<br>
          Officer: ${item.officer}<br>
          Date: ${item.date}
        `);
      }
    });
  </script>
</body>
</html>
