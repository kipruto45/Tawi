<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Make Donation | Tawi Tree Planting Project</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    body {
      background-image: url('{% static "img/tawi_forest_bg.jpg" %}');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 18px;
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.12);
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center bg-green-50/70">
  <div class="w-full max-w-md p-6 glass">
    <h1 class="text-xl font-bold text-green-700 mb-4 text-center">Make a Donation</h1>

    <form id="donation-form" method="POST" novalidate>
      {% csrf_token %}

      <!-- Amount Input -->
      <label class="block text-sm text-green-700 mb-1" for="id_amount">Amount (KSh)</label>
      <input id="id_amount" name="amount" type="number" step="0.01" min="1" required
             class="w-full p-2 border border-green-300 rounded focus:ring-2 focus:ring-green-500 mb-2"
             aria-describedby="amount-help">

      <p id="amount-help" class="text-xs text-green-500 mb-3">
        Enter the amount in Kenyan shillings (minimum KSh 1.00).
      </p>

      <!-- Payment Instructions -->
      <label class="block text-sm text-green-700 mb-1">Payment Instructions</label>
      <div class="text-sm text-green-700 bg-green-50 p-3 rounded mb-4 border border-green-100">
        <p>
          Please send payment to our <strong>M-Pesa Till or Paybill</strong>, then attach a screenshot or proof of payment
          in the <strong>Media</strong> section of your profile.
        </p>
        <p class="mt-2"><strong>Contact/Payment Number:</strong>
          <span class="font-mono text-green-800">0723484552</span>
        </p>
        <p class="mt-2">
          Include the <strong>transaction ID</strong> and <strong>payment date</strong> in the file name or description
          when you upload.
        </p>
      </div>

      <!-- Buttons -->
      <div class="flex items-center justify-between mt-4">
        <button id="donate-btn" type="submit"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center gap-1">
          <i data-feather="heart" class="w-4 h-4"></i> Donate
        </button>

        <a href="{% url 'donations:donations' %}"
           class="text-sm text-green-700 hover:underline flex items-center gap-1">
          <i data-feather="arrow-left" class="w-4 h-4"></i> Back to Donations
        </a>
      </div>
    </form>

    <!-- Feedback Message -->
    <div id="donation-feedback"
         class="mt-4 text-sm text-red-600 hidden"
         role="alert" aria-live="assertive"></div>
  </div>

  <!-- Validation Script -->
  <script>
    (function () {
      const form = document.getElementById('donation-form');
      const amount = document.getElementById('id_amount');
      const feedback = document.getElementById('donation-feedback');

      form.addEventListener('submit', (e) => {
        feedback.classList.add('hidden');
        feedback.textContent = '';

        const val = parseFloat(amount.value || '0');
        if (!val || val < 1) {
          e.preventDefault();
          feedback.classList.remove('hidden');
          feedback.textContent = 'Please enter a valid donation amount of at least KSh 1.00.';
          amount.focus();
          return false;
        }

        // If Stripe (or other payment integration) is enabled, attempt to create a payment intent first.
        // This is a non-blocking scaffold: if the endpoint isn't available the form will still submit
        // and the server-side view will try to create a Donation record as a fallback.
        try {
          fetch('{% url 'donations:create_payment_intent' %}', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': (document.cookie.split('csrftoken=')[1] || '').split(';')[0]},
            body: `amount=${encodeURIComponent(amount.value)}`
          }).then(r => r.json()).then(data => {
            if (data && data.client_secret) {
              // Here you would pass the client_secret to Stripe.js to complete payment.
              // For now we simply submit the form to let server-side placeholder handle it.
              form.submit();
            } else {
              // fallback: submit form and let server-side placeholder handle donation
              form.submit();
            }
          }).catch(() => {
            form.submit();
          });
        } catch (e) {
          form.submit();
        }
        return false;
      });
    })();
  </script>

  <script>feather.replace();</script>
</body>
</html>
