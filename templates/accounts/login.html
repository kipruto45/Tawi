{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login | Tawi Project</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    body {
      background-image: url('{% static "img/tawi_forest_bg.jpg" %}');
      background-size: cover;
      background-position: center;
    }
    .modern-card {
      background: rgba(255, 255, 255, 0.96);
      box-shadow: 0 4px 24px rgba(34, 197, 94, 0.15);
      border-radius: 18px;
      border: 1.5px solid #e5e7eb;
    }
    .login-anim {
      animation: loginFadeIn 1s cubic-bezier(.4,0,.2,1);
    }
    @keyframes loginFadeIn {
      from { opacity: 0; transform: translateY(30px) scale(0.97); }
      to { opacity: 1; transform: none; }
    }
  </style>
</head>
<body class="min-h-screen bg-cover bg-center relative flex items-center justify-center">
  <div class="absolute inset-0 bg-green-50/80"></div>
  
  <div class="relative z-10 flex items-center justify-center min-h-screen w-full">
    <div class="modern-card login-anim w-[96%] max-w-[20rem] p-4 md:p-5 text-green-900 shadow-xl">
      <!-- Login Form -->
      <div class="flex justify-center items-center mb-3">
  <a href="{% url 'core:landing' %}" class="inline-flex items-center gap-2 bg-white border border-green-200 text-green-700 px-3 py-1 rounded shadow-sm hover:bg-green-50">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 1.707a1 1 0 00-1.414 0l-7 7A1 1 0 003 10h1v6a1 1 0 001 1h4a1 1 0 001-1v-3h2v3a1 1 0 001 1h4a1 1 0 001-1v-6h1a1 1 0 00.707-1.707l-7-7z"/></svg>
          Home
        </a>
      </div>
      {% if request.GET.registered == '1' %}
        <div class="mb-3 text-sm text-green-800 bg-green-100 border border-green-200 rounded px-3 py-2">
          {% comment %} Show the latest success message which includes role if available; fallback text kept for compatibility. {% endcomment %}
          {% comment %} Show any success messages (registration added one). Avoid using non-standard tags like {% raw %}{% break %}{% endraw %}. {% endcomment %}
          {% for msg in messages %}
            {% if 'success' in msg.tags %}
              {{ msg }}
            {% endif %}
          {% empty %}
            Account created successfully. Please sign in below.
          {% endfor %}
        </div>
      {% endif %}
      <form method="POST" action="{% url 'accounts:login' %}" class="space-y-4">
        {% csrf_token %}
        {% if messages %}
          <div class="space-y-2">
            {% for msg in messages %}
              <div class="rounded px-3 py-2 text-xs {{ msg.tags }}">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <!-- Username -->
        <div class="relative">
          <i data-feather="user" class="absolute left-3 top-2.5 text-green-400"></i>
          <input type="text" name="username" placeholder="Username or Email" required
                 class="w-full pl-10 pr-3 py-2 bg-green-50 text-green-900 placeholder-green-400 rounded-md focus:ring-2 focus:ring-green-400 focus:outline-none border border-green-100 text-sm">
        </div>

        <!-- Password -->
        <div class="relative">
          <i data-feather="lock" class="absolute left-3 top-2.5 text-green-400"></i>
          <input type="password" name="password" placeholder="Password" required
                 class="w-full pl-10 pr-3 py-2 bg-green-50 text-green-900 placeholder-green-400 rounded-md focus:ring-2 focus:ring-green-400 focus:outline-none border border-green-100 text-sm">
        </div>

        <!-- Role -->
        <div class="relative">
          <i data-feather="users" class="absolute left-3 top-2.5 text-green-400"></i>
          <select name="role" required
                  class="w-full pl-10 pr-3 py-2 bg-green-50 text-green-900 rounded-md focus:ring-2 focus:ring-green-400 border border-green-100 text-sm appearance-none">
            <option value="" disabled selected>Select your role</option>
            <option value="admin">üåø Admin</option>
            <option value="field_officer">üßë‚Äçüåæ Field Officer</option>
            <option value="partner_institution">üè´ Partner Institution</option>
            <option value="project_manager">üë©‚Äçüíº Project Manager</option>
            <option value="volunteer">ü§ù Volunteer</option>
            <option value="guest">üë§ Guest</option>
          </select>
        </div>

        <!-- Remember + Forgot -->
        <div class="flex justify-between text-[11px] text-green-500">
          <label class="flex items-center">
            <input type="checkbox" name="remember" value="1" class="text-green-500 mr-2 rounded focus:ring-green-400">
            Remember Me
          </label>
          <a href="{% url 'password_reset' %}" class="hover:underline text-green-600">Forgot Password?</a>
        </div>

        <!-- Login Button -->
        <button type="submit"
                class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 transition-all py-2.5 rounded-md font-semibold shadow flex items-center justify-center gap-2 text-white text-sm">
          <i data-feather="log-in" class="w-4 h-4"></i> Sign In
        </button>
      </form>

      <!-- Divider -->
      <div class="flex items-center my-2">
        <hr class="flex-1 border-green-200">
        <span class="px-2 text-green-400 text-xs">OR</span>
        <hr class="flex-1 border-green-200">
      </div>

      <!-- Google Sign-in -->
      <div class="text-center mb-1">
        {% comment %} Prefer allauth provider login URL when available; fall back to our shim route. 
           Do NOT unconditionally load `socialaccount` here ‚Äî that tag library is only present
           when django-allauth is installed. The `provider_login_url` template tag in
           `accounts.templatetags.social_tags` already handles graceful fallback. {% endcomment %}
          <a href="{% provider_login_url 'google' process='login' %}"
             class="inline-flex items-center justify-center gap-2 w-full bg-white border border-green-200 py-2 rounded-md shadow hover:bg-green-50 text-sm font-medium text-green-600 transition">
            <img src="{% static 'img/google_icon.svg' %}" alt="Google" class="w-4 h-4"> Sign in with Google
          </a>
      </div>

      <!-- Guest Option -->
      <div class="text-center">
        <a href="{% url 'guest_dashboard' %}" 
           class="text-green-600 hover:underline text-xs">Continue as Guest</a>
      </div>

      <!-- Register link for anonymous users -->
      {% if not request.user.is_authenticated %}
      <div class="text-center mt-2">
        <a href="{% url 'accounts:register' %}" class="text-sm text-green-700 font-semibold hover:underline">Don't have an account? Register</a>
      </div>
      {% endif %}
      </div>
    </div>
  </div>

  <script>feather.replace();</script>
  <script>
    // Simple role-checker: calls an API to see if selected role matches stored user.role
    (function(){
      const roleSelect = document.querySelector('select[name="role"]');
      const usernameInput = document.querySelector('input[name="username"]');
      const submitBtn = document.querySelector('button[type="submit"]');

      function setWarning(text){
        let el = document.getElementById('role-warning');
        if(!el){
          el = document.createElement('div');
          el.id = 'role-warning';
          el.className = 'text-xs text-yellow-700 mt-1';
          roleSelect.parentNode.appendChild(el);
        }
        el.textContent = text;
      }

      let timer;
      function checkRole(){
        clearTimeout(timer);
        timer = setTimeout(async ()=>{
          const username = usernameInput.value.trim();
          const role = roleSelect.value;
          if(!username) return setWarning('');
          try{
              // include CSRF token in the header for POST requests
              function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
              }
              const csrftoken = getCookie('csrftoken');
              const res = await fetch('/accounts/api/role_check/', {
                method: 'POST',
                headers: {
                  'Content-Type':'application/json',
                  'X-Requested-With':'XMLHttpRequest',
                  'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({username, role})
              });
            if(!res.ok) return;
            const data = await res.json();
            if(!data.matches){
              setWarning('Selected role does not match this account. Contact admin to change role.');
            } else {
              setWarning('');
            }
          }catch(e){/* ignore */}
        }, 400);
      }

      if(roleSelect && usernameInput){
        roleSelect.addEventListener('change', checkRole);
        usernameInput.addEventListener('input', checkRole);
      }
    })();
  </script>
</body>
</html>